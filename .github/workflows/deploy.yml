name: Deploy to Windows Server

# Action ini berjalan otomatis ketika ada "git push" baru ke branch main.
on:
  push:
    branches:
      - main

jobs:
  deploy:
    # "self-hosted" memberitahu GitHub untuk menjalankan tugas ini di Windows Server Anda, bukan di sistem GitHub.
    runs-on: self-hosted

    steps:
      # Step 1: Tarik kode (Pull / Checkout) dari Repo
      - name: Checkout Code
        uses: actions/checkout@v4

      # Step 2: Update Server
      - name: Update Docker Containers and App
        shell: cmd
        run: |
          cd C:\Users\iam\Documents\abdinara.id\abdinara-lms
          git pull origin main
          
          echo "Membangun ulang container dengan versi terbaru..."
          docker compose up -d --build app
          
          echo "Membersihkan Cache Laravel..."
          docker compose exec -T app php artisan optimize:clear
          docker compose exec -T app php artisan view:clear
          
          echo "Menjalankan migrasi database..."
          docker compose exec -T app php artisan migrate --force
          
          echo "Aplikasi berhasil diperbarui di server!"
